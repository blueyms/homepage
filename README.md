# YMS 系统的设计探讨

## 良率管理在工业生产中占据极其重要的地位
  在一些行业，良率管理能力甚至可以被认为是企业核心竞争力。但是目前能够提供良率管理系统YMS（Yield Management System）产品的企业主要是美国企业等国外企业，且主要是面向半导体领域，如PDF Solution等，这是由于其在半导体领域的历史积累，且良率管理在半导体行业具备极其重要的影响。对于面板行业来说，良率管理在企业生产过程中也占据重要地位，但是市场上专门面向面板行业的YMS产品很少，已有部分企业尝试将半导体领域的YMS移植到面板行业，国内面板企业对YMS仍在探索阶段，或是自研YMS，或是先用多个分析软件进行手动分析，或是采购定制市场产品，不过相信随着国内企业在面板行业的发展并占据越来越多的市场份额，面板行业YMS会引起大家越来越多的重视，终会出现国产优秀YMS产品。本文将主要介绍我对面板行业YMS（YMS具备一定通用性，功能要求不一定限定于面板行业）的一些思考，抛砖引玉，期待更多行业人士的指正和讨论。

### 首先，为什么要YMS，或者说期望YMS能够解决哪些问题？

- 一、良率管控，企业管理层或工程师需要实时了解企业整体良率情况，因此YMS需要提供良率看板，通过可视化图表清晰明了展示各厂、各线、各站点、各产品、或各批次等良率情况，并对异常良率情况做到自动报警提示；
- 二、良率分析，针对出现良率异常的情况，需要分析导致良率异常的原因，良率工程师或整合工程师等会对异常情况进行分析，往往会进行缺陷集中性分析、缺陷map图分析、路径分析以及参数分析等操作，以期发现导致异常的站点、设备、物料乃至制程参数等，然后消除异常因子，提升良率；三、生产管控，通过对良率数据的分析，YMS对接生产系统后可以对生产安排做出管控，如生产设备调整、物料调整、生产参数调整、生产测试规划等，能够帮助产线生产尽可能快地发现缺陷产品或减少缺陷产品的数量；四、缺陷分析，YMS系统要能够快速展示缺陷，并对缺陷进行自动分类，以便后续进一步分析，甚至要求能够利用图像识别等算法自动识别或辅助识别产品缺陷；五、良率预测，在近几年人工智能浪潮的背景下，越来越多的YMS能够提供良率预测功能，根据各种参数对某些量测值进行虚拟测量等。

###  根据上面的业务需求，那么YMS系统的功能架构应当如何呢？下图是一个初步整理的YMS功能架构图，主要包括数据层、治理层、计算层和应用层。

![image](https://github.com/blueyms/homepage/assets/145177887/cb8e7516-5fb0-4fc9-8402-66202c4c6aba)


## 数据层是YMS
- YMS的基础，包括履历数据、制程数据、量测数据、良率数据、defect数据等，从物料相关数据、生产相关数据、成品相关数据到售后相关数据均需要收集，以便能支撑YMS全方位的管控和分析功能。
- 数据层需要支撑多种数据类型，如制程数据往往是大数量的时序数据，defect数据可能是扫描图片，因此需要考虑大数据量、多种类的数据采集和存储要求。此外数据层还要具备数据监控能力，即数据采集异常时能够进行报警，否则若在应用层发现问题，经过层层排查才能发现是数据本身出现问题，
- 这个过程可能涉及多个不同部门人员的沟通协作，非常耗时琐碎，浪费大量人力，也导致后续系统维护成本大大提升，甚至可能造成系统最终被弃用。

## 治理层是YMS系统必备条件:
  包括数据清洗、数据转换、数据关联、字段对齐等工作，经过数据治理后的数据才能提供给系统进行后续计算分析。梳理治理层的需求工作量巨大，需要产品经理和项目经理做好评估，否则极可能导致产品或项目时间来不及，或者成本攀升。

## 数据治理
- 数据治理需要业务人员、IT人员和产品人员协同配合，且一般企业里面很难找到一个业务人员对所有数据情况和数据需求都熟悉，往往是一个业务人员熟悉某个厂或某个模块的数据情况，因此数据梳理就需要面对多个业务人员。同时，可能企业之前数据质量存在较大问题，如没有一个统一的字段维护工具，但字段可能有几十万甚至更多，在字段梳理阶段即可能耗费大量人力。再者，数据异常情况业务人员也不清楚，需要查看分析数据库里面的原始数据才能发现，在系统上线前需要把数据异常情况尽量梳理出来。最后，数据权限的限制往往需要大量的协调工作才能解决或者需要企业有专门的人员负责从上往下推进。数据治理虽然需要大量人力投入，却是整个YMS产品或项目不可缺少的环节，一旦完成，还可以对其他产品或项目输出高质量的数据。

## 计算层
- 计算层是YMS系统的关键支撑，需要支持统计分析、机器学习、深度学习各类算法，支持容器云，计算框架一般包括离线批处理运算框架、实时流运算框架及机器学习框架。
- 工厂数据很多时候数据量巨大，像生产制程数据可能一秒一笔，而工厂有很多机台和设备，那么一天就能产生大量的数据，那么就需要离线批处理运算框架来对大数据量的数据进行计算；同时，工厂的数据计算很多时候也需要实时计算、快速反馈，如发现某个设备异常集中，就需要快速调整生产，替换掉该设备，避免后续大批量不良产品生产出来，所以也需要实时流运算框架；随着技术的进步，YMS系统越来越多引入人工智能的算法，如利用机器学习、深度学习进行虚拟量测，可以达到实时预测一些量测值，这样就能避免以前只能实际抽检导致出现异常产品无法及时发现的问题，因此也需要支持机器学习框架。

## 应用层

- 应用层是YMS的直观表现，是用户真正感受和使用的功能模块，直接体现YMS的价值。应用层可能包括良率看板、Defect分析、良率集中性分析、参数分析、生产管控、良率报告、良率预测和自助分析等功能模块。

### 良率看板
- 良率看板主要是利用数据可视化技术全景展示工厂良率状况，帮助管理层和工程师快速全面了解工厂良率水平。良率看板要保证数据的实时性和准确性，图表形式直观展示数据、支持数据的下钻查看并支持设置良率报警规则，帮助工程师及时发现良率问题和症结，及时做出生产调整和安排，减少不良产品的生产。

- Defect分析可以支持defect可视化、defect自动聚类等。defect可视化包括快捷查看实际defect图片或数据，也包括将一个glass的所有Panel按实际位置展示标识，也包括将多个glass的defect以叠图的形式可视化展示以便找到defect位置分布规律。Defect自动聚类可以根据每个glass的defect位置分布进行自动聚类，即将defect位置分布相似相近的所有glass分为一类，帮助工程师发现defect位置分布规律并可依据分布类别进一步进行后续分析。

- 良率集中性分析包括时间集中性分析、设备集中性分析、glass集中性分析等。集中性分析利用数据统计分析不良集中情况，并用可视化图表直观展示。需要注意的是需要给用户提供灵活的数据筛选功能，保证用户能简便灵活分析目标数据的集中性。

- 参数分析一般是用户在获得集中性分析结论或者聚类发现defect类别后，针对不良集中或某一defect类别的数据进行深入参数分析，以期能够发现导致不良产品的影响因素，从而及时消除不良因素。参数分析可以利用统计学方法如利用主成分分析PCA先进行降维，然后对区别明显的两组数据进行对比分析，获得影响因子排序，也可以利用机器学习等方法挖掘影响因子。由于参数分析的结果是影响因子的排序，那么在TOP10的因子能否包含真正的影响因子是评价参数分析效果的核心指标，目前一些市场专门做参数分析的软件效果实际一般，因为数据的状况变化多端往往很多导致分析效果大打折扣，因此如果能在产品设计上主动发现数据各类状况，并自动处理特殊数据或引导用户进行相应数据处理，最终保证参数分析效果，产品将因此获得较大优势。此外，传统的参数分析一般不提供用户录入参数分析结果的功能，即用户在系统层面没法反馈哪个或哪些是真正的影响因子，导致参数分析没有真正形成闭环，用户的分析经验和分析结论无法助力系统完成迭代优化，因此新一代的YMS有必要在产品设计上考虑这一部分。

- 生产管控是根据YMS分析结果指导生产系统MES进行相应的管控，从而及时发现异常产品或及时调整生产计划以减少不良产品数量。常见的生产管控包括设备hold/更换、生产参数调整、抽检动态规划、物料hold/更换等。

- 若YMS分析发现不良产品具备设备集中性特征，则可实时对目标设备进行hold或换另一台设备进行生产；若通过参数分析发现导致不良的影响参数，则可调整该生产参数；若通过虚拟量测预测当前产品异常，则指导进行产品的加检，系统也可根据预测结果进行抽检的动态规划，相比传统的固定抽检，将能提升抽检效果，更加及时发现产品异常；若YMS分析发现不良产品有物料批次集中性，则可以指导及时更换物料批次并退换产线上的相应物料批次，降低不良产品数量。良率预测在人工智能浪潮下越来越成为YMS的核心功能。



- 在大规模流水线的生产背景下，产品质量的检测往往只能通过抽检来进行监控，无法实现所有产品的全检，这种事后检测的机制在检测出异常产品时往往意味着已经生产了一批不良品，在现在传统的SPC软件中，会对单个变量进行监控，设置规格线进行预警，但在实际生产过程中可能是多个变量对量测值产生影响，很多情况下量测值异常时发现SPC中多个变量均在各自规格线内，因而无法提前预警。对于以上场景，可以采用虚拟量测的方法来预测量测值，即不实际测量产品，而是通过多个生产变量模拟预测量测值，这样就可以实现所有产品的“全检”或多个变量影响的综合考虑，在模型预测发现量测值异常时，可以及时安排加检，快速及时找到异常产品，减少不良产品的产生。

## 虚拟量测
- 虚拟量测具备巨大的降本增效价值，必然成为智能制造的趋势和YMS的核心功能，但目前而言仍然存在不小的挑战。要能发挥虚拟量测价值，核心在于模型预测的召回率和准确率能否达到实际应用标准，而实际生产中要求模型的准确率和召回率要求很高，尤其是准确率要求很高，但实际的数据质量较差难以训练产生优质模型，因此模型高要求和数据低质量的矛盾成为当前虚拟量测无法快速大规模推广的核心原因。模型要求高准确率，否则对实际生产会造成严重影响，比如一个模型有70%的准确率，在一些场景中如推荐系统可能算是很好的一个模型，但是在工业生产中可能就意味着是一个无法实用的模型，因为还有30%的情况是报假警，导致产线工程师和工人对其失去信心，进而弃用；模型也要求召回率不能太低，太低的召回率说明大部分异常情况没有被模型发现，从而大大降低模型的实际价值，也可能让产线工程师和工人对其失去信心。不过从实际应用来看，准确率的优先级往往要高于召回率，因为实际生产中往往有固定抽检可以来进行兜底保证。数据的低质量往往表现在有监督样本过少而影响因素又过多。由于是抽检，即意味着有监督的样本比较少，又由于大规模生产中异常情况比例很低，即意味着有监督样本中异常标记样本更少，另外一个产品往往只生产几个月-几年，那么历史累积的数据量就不是很多，而且在生产过程中往往又会有调机、更换供应商等操作，导致积累的数据也不能一视同仁地投入模型训练验证；另一方面，生产制程参数可能有几百个，同时还有物料参数等，即意味着数据的影响因子过多，同时可能还存在着一些影响因子没办法采集，可能会存在影响因子缺失的情况。当然工业数据质量还存在数据丢失、数据错误以及操作数据没有记录等问题，导致模型训练困难程度加大。不过如果能有较好的业务经验协助模型构建，或者不同产品之间、同一产品不同时间段之间应用迁移学习等算法，有可能部分解决或缓解数据问题。并且随着虚拟量测的应用，数据采集更加规范更加全面，数据质量应当会迎来一次大的跃升，推动虚拟量测模型质量的提升。

- 在YMS中数据处理、数据展示和数据分析都是相对固定的路径。而在实际应用中，面对良率管理的众多场景，企业往往也给工程师配置自助工具，主要包括自助BI工具和自助数据挖掘工具两类，因此YMS也可以配置自助分析功能模块，保障用户自助自主探索的空间。

### 自助BI
- 自助BI工具市场上主要有spotfire、帆软BI软件等，在面板行业中自助BI工具要求能够快速处理千万行级、亿行级的数据量，需要在硬件和软件架构上保证数据处理速度，同时也要求产品操作的简便性。
- 自助数据挖掘工具市场上有SIMCA、SPSS等，在面板行业中要求能够快速分析良率集中，能够准确挖掘异常影响因子，能够帮助工程师快速准确找到异常影响因子将成为核心能力。

